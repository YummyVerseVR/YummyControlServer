# ControlServer

## 実行方法
```
uv sync
uv run src/entry.py
```

## 引数一覧
- `--port / -p`: サーバのポート番号
    - デフォルト: 8000

- `--config / -c`: 設定ファイルのパス
    - デバッグ等の用途で設定ファイルを変更したい場合に指定します.
    - デフォルト: `./config.json`

- `--debug / -d`: デバッグモードを有効化
    - デバッグが有効な場合, 一部のAPIエンドポイントが有効化される他, loggingを除くすべてのネットワークを必要とする処理が無効化されます.
    - デフォルト: 無効

- `--logging / -l`: ネットワークロギングを有効化
    - 有効な場合はpylognetを使用してログサーバにログを送信します.
    - デフォルト: 無効

## config.jsonの仕様
設定ファイル`config.json`は以下の形式で記述します.
```json
{
    "db": {
        "path": "データベースのパス(必須)"
    },
    "endpoints": {
        "audio": "オーディオ生成サーバのURL(必須)",
        "model": "モデル生成サーバのURL(必須)",
        "ollama": "OllamaサーバのURL(必須)",
        "logger": "ログサーバのURL(任意)"
    },
    "ollama": {
        "model": "モデル名(必須)",
        "prompt": "Ollamaへのプロンプトテンプレート(必須)",
        "candidates": [
            "近い食感か判定するための候補リスト(必須)",
            "{ "name": "食品名" } の形式で複数指定",
        ],
        "temperature": "モデルの温度(任意)",
        "num_predict": "思考回数(任意)"
    },
    "email": {
        "scopes": ["Google APIのスコープ(必須)"],
        "from": "送信元メールアドレス(必須)",
        "credential": "Google APIの認証情報ファイルパス(必須)",
        "token": "Google APIのトークンファイルパス(必須)"
    }
}
```

## APIエンドポイント
このサーバは以下のAPIエンドポイントを提供します. 詳細な仕様についてはFastAPIの自動生成ドキュメント`http://0.0.0.0/8000/docs`を参照してください.

- `/request`: ユーザーのリクエスト
    - メソッド: POST
    - 説明: Google Formで収集したユーザのリクエストを元にデータの準備を開始します.
    - リクエストの引数(**JSON**):
        - `email` (str): ユーザーID
        - `request` (str): ユーザーのリクエスト内容

- `/{user_id}/status`: ユーザーステータスの取得
    - メソッド: GET
    - 説明: 指定されたユーザーのデータステータスを取得します. すべてのデータが準備できている場合は`true`を返します.

- `/save/image`: モデル生成元の画像データの保存
    - メソッド: POST
    - 説明: 指定された画像データをユーザに紐づけて保存します.
    - リクエストの引数:
        - `user_id` (str): ユーザーID
        - `file` (UploadFile): 画像データ (io.BytesIO型で受け取れる)

- `/save/model`: モデルデータの保存
    - メソッド: POST
    - 説明: 指定されたモデルデータをユーザに紐づけて保存します.
    - リクエストの引数:
        - `user_id` (str): ユーザーID
        - `file` (UploadFile): モデルデータ (io.BytesIO型で受け取れる)

- `/save/audio`: 音声データの保存
    - メソッド: POST
    - 説明: 指定された音声データをユーザに紐づけて保存します.
    - リクエストの引数:
        - `user_id` (str): ユーザーID
        - `file` (UploadFile): 音声データ (io.BytesIO型で受け取れる)

- `/create`:ユーザーを新しく作成(**debugモード時のみ使用可能**)
    - メソッド: GET
    - 説明: 新しくユーザーを作成し, 対応するQRコードを作成・保存します. 作成したユーザーの`user_id`を返します.

- `/{user_id}/status`: ユーザーステータスの取得
    - メソッド: GET
    - 説明: 指定されたユーザーのデータステータスを取得します. すべてのデータが準備できている場合は`true`を返します.

- `/{user_id}/image`: 画像データの取得
    - メソッド: GET
    - 説明: 指定されたユーザーの画像データを取得します.

- `/{user_id}/model`: モデルデータの取得
    - メソッド: GET
    - 説明: 指定されたユーザーのモデルデータを取得します.

- `/{user_id}/audio`: 音声データの取得
    - メソッド: GET
    - 説明: 指定されたユーザーの音声データを取得します

- `/{user_id}/param`: パラメータデータの取得
    - メソッド: GET
    - 説明: 指定されたユーザーのパラメータデータを取得します

- `/get-users`: ユーザーリストの取得
    - メソッド: GET
    - リクエストの引数:
        - `n` (int): 取得するユーザー数 (省略時は直近10ユーザー)
    - 説明: 現在サーバに登録されているユーザーのリストを取得します.
    - リストの各要素:
        - `uuid` (str): ユーザーID
        - `status` (bool): ユーザーデータが準備完了しているかどうか
        - `request` (str): ユーザーのリクエスト内容

- `/ping`: ヘルスチェック
    - メソッド: GET
    - 説明: サーバが稼働しているかどうかを確認します. 常に`pong`を返します.
